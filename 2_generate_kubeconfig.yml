---
- name: Generate kubeconfig for K3s Cluster
  hosts: k8s_controlplane[0]  # Target only the first control plane node
  become: true
  gather_facts: false

  collections:
    - kubernetes.core

  vars_files:
    - secrets.yml

  tasks:
    - name: Fetch the control plane IP from inventory
      set_fact:
        control_plane_ip: "{{ hostvars[inventory_hostname]['ansible_host'] }}"

    - name: Fetch the CA certificate from the control plane
      slurp:
        src: /var/lib/rancher/k3s/server/tls/server-ca.crt
      register: ca_cert

    - name: Fetch the K3s node token from the control plane
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_token

    - name: Gather necessary variables locally
      set_fact:
        local_ca_cert: "{{ ca_cert.content }}"  # Use directly, already base64-encoded
        local_node_token: "{{ node_token.content | b64decode | trim }}"  # Decode to get actual token
      delegate_to: localhost

    - name: Create kubeconfig file
      copy:
        content: |
          apiVersion: v1
          clusters:
          - cluster:
              certificate-authority-data: "{{ local_ca_cert }}"
              server: https://{{ control_plane_ip }}:6443
            name: k3s-cluster
          contexts:
          - context:
              cluster: k3s-cluster
              user: admin
            name: default
          current-context: default
          kind: Config
          preferences: {}
          users:
          - name: admin
            user:
              token: "{{ local_node_token }}"
        dest: /etc/rancher/k3s/kubeconfig.yaml
        mode: '0644'
      delegate_to: localhost

    - name: Distribute kubeconfig to other control plane nodes
      ansible.builtin.copy:
        src: /etc/rancher/k3s/kubeconfig.yaml
        dest: /etc/rancher/k3s/kubeconfig.yaml
        owner: root
        group: root
        mode: '0644'
      loop: "{{ groups['k8s_controlplane'] }}"
      when: inventory_hostname != item
